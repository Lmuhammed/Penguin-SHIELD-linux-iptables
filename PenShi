#!/bin/bash

iptablesWithSudo(){
    sudo iptables "$@"
}
usage() {
    echo "Usage: $0 [start|stop|status|flush]"
    exit 1
}

start_firewall() {
    echo "Starting firewall..."

    # Flush existing rules
    $iptablesWithSudo -F

    # Set default policies
    $iptablesWithSudo -P INPUT DROP
    $iptablesWithSudo -P FORWARD DROP
    $iptablesWithSudo -P OUTPUT ACCEPT

    # Allow established connections
    $iptablesWithSudo -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

    # Allow SSH (port 22)
    $iptablesWithSudo -A INPUT -p tcp --dport 22 -j ACCEPT

    # Allow HTTP (port 80)
    $iptablesWithSudo -A INPUT -p tcp --dport 80 -j ACCEPT

    # Allow HTTPS (port 443)
    $iptablesWithSudo -A INPUT -p tcp --dport 443 -j ACCEPT

    echo "Firewall started with default rules."
}
stop_firewall() {
    echo "Stopping firewall..."
    $iptablesWithSudo -F
    $iptablesWithSudo -P INPUT ACCEPT
    $iptablesWithSudo -P FORWARD ACCEPT
    $iptablesWithSudo -P OUTPUT ACCEPT
    echo "Firewall stopped. All traffic is allowed."
}
status_firewall() {
    echo "Current $iptablesWithSudo rules:"
    iptablesWithSudo -L -n -v
}

flush_firewall() {
    echo "Flushing all $iptablesWithSudo rules..."
    sudo $iptablesWithSudo -F
    echo "All rules flushed."
}

if [ $# -ne 1 ]; then
    usage
fi

case $1 in
    start)
        start_firewall
        ;;
    stop)
        stop_firewall
        ;;
    status)
        status_firewall
        ;;
    flush)
        flush_firewall
        ;;
    *)
        usage
        ;;
esac

